# Put this inside your nginx server block. Example:
# server {
#   listen 80;
#   server_name _;
#
#   include /etc/nginx/snippets/nvr_streams.conf;
#
#   location / {
#     root /var/www/html;
#     try_files $uri /index.html;
#   }
# }
#
# Serve HLS streams written by FFmpeg (or the backend)
# Tip: ensure your backend writes to /var/www/streams (see application.yml)

# Manifests: no-store to avoid any stale caching
location ~* \.m3u8$ {
    add_header Access-Control-Allow-Origin * always;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires 0 always;
    types { application/vnd.apple.mpegurl m3u8; }
    root /var/www;  # so that /streams/... maps to /var/www/streams/...
}

# Segments: short cache is fine; clients rarely re-request old segments
location ~* \.ts$ {
    add_header Access-Control-Allow-Origin * always;
    add_header Cache-Control "public, max-age=60" always;
    types { video/mp2t ts; }
    root /var/www;
}

# Default for other assets under /streams/
# Do not use ^~ so regex locations for .m3u8/.ts can take precedence
location /streams/ {
    alias /var/www/streams/;
    add_header Access-Control-Allow-Origin * always;
    # Conservative default; extension-specific blocks override as needed
    add_header Cache-Control no-cache always;
    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
    }
}
